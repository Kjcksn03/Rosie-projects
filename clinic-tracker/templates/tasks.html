{% extends "base.html" %}
{% block title %}Tasks â€“ {{ clinic.name }}{% endblock %}
{% block content %}
<div class="container">
  <div class="breadcrumb">
    <a href="{{ url_for('index') }}">Clinics</a>
    <span class="breadcrumb-sep">â€º</span>
    <a href="{{ url_for('clinic_dashboard', clinic_id=clinic.id) }}">{{ clinic.name }}</a>
    <span class="breadcrumb-sep">â€º</span>
    <span>Tasks</span>
  </div>

  <div class="page-header">
    <div class="page-title">ğŸ“‹ {{ clinic.name }} â€“ Tasks</div>
    <div class="d-flex gap-2 flex-wrap">
      {% if session.role in ('admin', 'dept_head') %}
      <a href="{{ url_for('new_task', clinic_id=clinic.id) }}" class="btn btn-gold">â• Add Task</a>
      {% endif %}
      <a href="{{ url_for('clinic_dashboard', clinic_id=clinic.id) }}" class="btn btn-outline">â† Dashboard</a>
    </div>
  </div>

  <!-- Filters -->
  <form method="GET" class="filters-bar">
    <select name="dept" onchange="this.form.submit()">
      <option value="">All Departments</option>
      {% for d in departments %}
      <option value="{{ d }}" {% if dept_filter == d %}selected{% endif %}>{{ d }}</option>
      {% endfor %}
    </select>
    <select name="phase" onchange="this.form.submit()">
      <option value="">All Phases</option>
      {% for p in time_phases %}
      <option value="{{ p }}" {% if phase_filter == p %}selected{% endif %}>{{ p }}</option>
      {% endfor %}
    </select>
    <select name="status" onchange="this.form.submit()">
      <option value="">All Statuses</option>
      {% for s in statuses %}
      <option value="{{ s }}" {% if status_filter == s %}selected{% endif %}>{{ s }}</option>
      {% endfor %}
    </select>
    {% if dept_filter or phase_filter or status_filter %}
    <a href="{{ url_for('clinic_tasks', clinic_id=clinic.id) }}" class="btn btn-outline btn-sm">âœ• Clear</a>
    {% endif %}
  </form>

  {% if tasks %}
    {% set ns = namespace(current_dept='') %}
    {% for task in tasks %}
      {% if task.department != ns.current_dept %}
        {% if ns.current_dept != '' %}</div></div>{% endif %}
        {% set ns.current_dept = task.department %}
        <div class="dept-section">
          <div class="dept-header">
            <div class="dept-header-left">
              <span class="collapse-icon">â–¼</span>
              <span>{{ task.department }}</span>
            </div>
            <div class="dept-header-right">
              {% set dept_tasks = tasks | selectattr('department', 'equalto', task.department) | list %}
              {% set done = dept_tasks | selectattr('status', 'equalto', 'Complete') | list | length %}
              <span>{{ done }}/{{ dept_tasks|length }} done</span>
            </div>
          </div>
          <div class="dept-body">
          <div style="overflow-x:auto">
          <table class="task-table">
            <thead>
              <tr>
                <th>Task</th>
                <th class="task-col-phase">Phase</th>
                <th>Due Date</th>
                <th>Status</th>
                <th class="task-col-assignee">Assignees</th>
              </tr>
            </thead>
            <tbody>
      {% endif %}
      {% set is_overdue = task.due_date and task.due_date < today_str and task.status != 'Complete' %}
      <tr class="{% if task.status == 'Blocked' %}task-blocked{% elif is_overdue %}task-overdue{% endif %}">
        <td>
          <a href="{{ url_for('task_detail', task_id=task.id) }}" class="task-name-link">{{ task.name }}</a>
        </td>
        <td class="task-col-phase"><span class="badge badge-not-started" style="background:var(--gray-100)">{{ task.time_phase or 'â€“' }}</span></td>
        <td>
          {% if task.due_date %}
            {% if is_overdue %}<span style="color:var(--danger);font-weight:600">{{ task.due_date }}</span>
            {% else %}{{ task.due_date }}{% endif %}
          {% else %}â€“{% endif %}
        </td>
        <td>
          {% if task.status == 'Not Started' %}<span class="badge badge-not-started">{{ task.status }}</span>
          {% elif task.status == 'In Progress' %}<span class="badge badge-in-progress">{{ task.status }}</span>
          {% elif task.status == 'Complete' %}<span class="badge badge-complete">{{ task.status }}</span>
          {% elif task.status == 'Blocked' %}<span class="badge badge-blocked">{{ task.status }}</span>
          {% endif %}
        </td>
        <td class="task-col-assignee">
          {% set assignee_ids = task.assignees | from_json %}
          {% for uid in assignee_ids %}
            {% for u in users %}{% if u.id|string == uid|string %}<span class="badge badge-not-started" style="margin:2px">{{ u.full_name }}</span>{% endif %}{% endfor %}
          {% endfor %}
        </td>
      </tr>
    {% endfor %}
    {% if tasks %}</tbody></table></div></div></div>{% endif %}
  {% else %}
  <div class="empty-state">
    <div class="empty-state-icon">ğŸ“‹</div>
    <div>No tasks found{% if dept_filter or phase_filter or status_filter %} matching your filters{% endif %}.</div>
  </div>
  {% endif %}
</div>

{% block scripts %}
<script>
const todayStr = "{{ today_str if today_str is defined else '' }}";
</script>
{% endblock %}
{% endblock %}
