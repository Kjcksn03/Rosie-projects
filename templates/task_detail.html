{% extends "base.html" %}
{% block title %}{{ task.name }} â€“ VIP Clinic Launch Tracker{% endblock %}
{% block content %}
<div class="container">
  <div class="breadcrumb">
    <a href="{{ url_for('index') }}">Clinics</a>
    <span class="breadcrumb-sep">â€º</span>
    <a href="{{ url_for('clinic_dashboard', clinic_id=clinic.id) }}">{{ clinic.name }}</a>
    <span class="breadcrumb-sep">â€º</span>
    <a href="{{ url_for('clinic_tasks', clinic_id=clinic.id) }}">Tasks</a>
    <span class="breadcrumb-sep">â€º</span>
    <span>{{ task.name[:40] }}{% if task.name|length > 40 %}â€¦{% endif %}</span>
  </div>

  <div class="card mb-3">
    <div class="task-detail-header">
      <h1>{{ task.name }}</h1>
      <div class="task-detail-meta">
        <span>ğŸ¢ {{ task.department }}</span>
        {% if task.time_phase %}<span>â± {{ task.time_phase }}</span>{% endif %}
        {% if task.due_date %}<span>ğŸ“… Due {{ task.due_date }}</span>{% endif %}
        <span>
          {% if task.status == 'Not Started' %}<span class="badge badge-not-started">{{ task.status }}</span>
          {% elif task.status == 'In Progress' %}<span class="badge badge-in-progress">{{ task.status }}</span>
          {% elif task.status == 'Complete' %}<span class="badge badge-complete">{{ task.status }}</span>
          {% elif task.status == 'Blocked' %}<span class="badge badge-blocked">{{ task.status }}</span>
          {% endif %}
        </span>
      </div>
    </div>
  </div>

  <div class="task-detail-grid">
    <!-- Left: notes + attachments -->
    <div>
      <!-- Notes -->
      <div class="card mb-3">
        <div class="card-header">
          <span class="card-title">ğŸ’¬ Notes & Updates</span>
        </div>
        <div class="card-body">
          <div class="note-thread mb-3">
            {% if notes %}
              {% for n in notes %}
              <div class="note-item">
                <div class="note-header">
                  <span class="note-author">{{ n.full_name }}</span>
                  <span>{{ n.created_at[:16] }}</span>
                </div>
                <div class="note-content">{{ n.content }}</div>
              </div>
              {% endfor %}
            {% else %}
            <div class="text-muted text-center" style="padding:16px">No notes yet. Be the first to add an update!</div>
            {% endif %}
          </div>
          {% if can_edit %}
          <form method="POST" action="{{ url_for('task_detail', task_id=task.id) }}">
            <input type="hidden" name="action" value="add_note">
            <div class="form-group mb-1">
              <textarea name="content" class="form-control" rows="3" placeholder="Add a noteâ€¦ use @username to mention someone"></textarea>
            </div>
            <button type="submit" class="btn btn-primary btn-sm">Post Note</button>
          </form>
          {% endif %}
        </div>
      </div>

      <!-- Attachments -->
      <div class="card">
        <div class="card-header">
          <span class="card-title">ğŸ“ Attachments</span>
        </div>
        <div class="card-body">
          {% if attachments %}
          <div class="attachment-list mb-3">
            {% for a in attachments %}
            <div class="attachment-item">
              <span class="attachment-icon">ğŸ“„</span>
              <a href="{{ url_for('uploaded_file', filename=a.filename) }}" class="attachment-name" target="_blank">{{ a.original_name }}</a>
              <span class="attachment-meta">by {{ a.full_name }} Â· {{ a.created_at[:10] }}</span>
            </div>
            {% endfor %}
          </div>
          {% endif %}
          {% if can_edit %}
          <form method="POST" enctype="multipart/form-data" action="{{ url_for('task_detail', task_id=task.id) }}">
            <input type="hidden" name="action" value="upload">
            <div class="d-flex gap-2 align-center flex-wrap">
              <input type="file" name="file" class="form-control" style="max-width:280px">
              <button type="submit" class="btn btn-outline btn-sm">Upload</button>
            </div>
            <small class="text-muted">PDF, images, Word, Excel, TXT (max 16MB)</small>
          </form>
          {% endif %}
        </div>
      </div>
    </div>

    <!-- Right: Edit form -->
    <div>
      <div class="card">
        <div class="card-header">
          <span class="card-title">âœï¸ Task Details</span>
        </div>
        <div class="card-body">
          {% if can_edit %}
          <form method="POST" action="{{ url_for('task_detail', task_id=task.id) }}">
            <input type="hidden" name="action" value="update">
            <div class="form-group">
              <label class="form-label">Task Name</label>
              <input type="text" name="name" class="form-control" value="{{ task.name }}" required>
            </div>
            <div class="form-group">
              <label class="form-label">Department</label>
              <select name="department" class="form-control">
                {% for d in departments %}
                <option value="{{ d }}" {% if d == task.department %}selected{% endif %}>{{ d }}</option>
                {% endfor %}
              </select>
            </div>
            <div class="form-group">
              <label class="form-label">Time Phase</label>
              <select name="time_phase" class="form-control">
                <option value="">â€“</option>
                {% for p in time_phases %}
                <option value="{{ p }}" {% if p == task.time_phase %}selected{% endif %}>{{ p }}</option>
                {% endfor %}
              </select>
            </div>
            <div class="form-group">
              <label class="form-label">Due Date</label>
              <input type="date" name="due_date" class="form-control" value="{{ task.due_date or '' }}">
            </div>
            <div class="form-group">
              <label class="form-label">Status</label>
              <select name="status" class="form-control">
                {% for s in statuses %}
                <option value="{{ s }}" {% if s == task.status %}selected{% endif %}>{{ s }}</option>
                {% endfor %}
              </select>
            </div>
            <div class="form-group">
              <label class="form-label">Assignees</label>
              <select name="assignees" class="form-control" multiple style="height:120px">
                {% for u in users %}
                <option value="{{ u.id }}" {% if u.id|string in assignee_ids %}selected{% endif %}>{{ u.full_name }}</option>
                {% endfor %}
              </select>
              <small class="text-muted">Ctrl/Cmd to multi-select</small>
            </div>
            <button type="submit" class="btn btn-gold w-100" style="justify-content:center">Save Changes</button>
          </form>
          {% else %}
          <div class="text-muted" style="font-size:14px">
            <p><strong>Department:</strong> {{ task.department }}</p>
            <p><strong>Phase:</strong> {{ task.time_phase or 'â€“' }}</p>
            <p><strong>Due:</strong> {{ task.due_date or 'â€“' }}</p>
            <p><strong>Status:</strong> {{ task.status }}</p>
            <p class="mt-2"><em>You have read-only access to this task.</em></p>
          </div>
          {% endif %}
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}
