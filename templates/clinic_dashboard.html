{% extends "base.html" %}
{% block title %}{{ clinic.name }} â€“ VIP Clinic Launch Tracker{% endblock %}
{% block content %}
<div class="container">
  <div class="breadcrumb">
    <a href="{{ url_for('index') }}">Clinics</a>
    <span class="breadcrumb-sep">â€º</span>
    <span>{{ clinic.name }}</span>
  </div>

  <div class="page-header">
    <div>
      <div class="page-title">{{ clinic.name }}</div>
      {% if clinic.opening_date %}
      <div class="page-subtitle">ğŸ—“ï¸ Target Opening: {{ clinic.opening_date }}</div>
      {% endif %}
    </div>
    <div class="d-flex gap-2 flex-wrap">
      <a href="{{ url_for('clinic_tasks', clinic_id=clinic.id) }}" class="btn btn-primary">ğŸ“‹ View All Tasks</a>
      <a href="{{ url_for('quick_check', clinic_id=clinic.id) }}" class="btn btn-outline">ğŸ” Quick Check</a>
      {% if session.role == 'admin' %}
      <a href="{{ url_for('new_task', clinic_id=clinic.id) }}" class="btn btn-gold">â• Add Task</a>
      <form method="POST" action="{{ url_for('delete_clinic', clinic_id=clinic.id) }}" class="confirm-delete" style="display:inline">
        <button class="btn btn-danger btn-sm">ğŸ—‘ï¸ Delete</button>
      </form>
      {% endif %}
    </div>
  </div>

  <!-- Overall stats -->
  <div class="stats-row">
    <div class="stat-card">
      <div class="stat-number">{{ pct_all }}%</div>
      <div class="stat-label">Overall Complete</div>
    </div>
    <div class="stat-card success">
      <div class="stat-number">{{ tasks | selectattr('status', 'equalto', 'Complete') | list | length }}</div>
      <div class="stat-label">Tasks Done</div>
    </div>
    <div class="stat-card warning">
      <div class="stat-number">{{ tasks | selectattr('status', 'equalto', 'In Progress') | list | length }}</div>
      <div class="stat-label">In Progress</div>
    </div>
    <div class="stat-card danger">
      <div class="stat-number">{{ blocked | length }}</div>
      <div class="stat-label">Blocked</div>
    </div>
    <div class="stat-card danger">
      <div class="stat-number">{{ overdue | length }}</div>
      <div class="stat-label">Overdue</div>
    </div>
  </div>

  <!-- Overall progress bar -->
  <div class="card mb-3">
    <div class="card-body">
      <div class="d-flex align-center gap-2 mb-1">
        <span style="font-weight:600;color:var(--navy)">Overall Progress</span>
        <span class="badge badge-gold">{{ pct_all }}%</span>
      </div>
      <div class="progress-bar-wrap" style="height:14px">
        <div class="progress-bar-fill" style="width:{{ pct_all }}%"></div>
      </div>
    </div>
  </div>

  <!-- Two columns: dept progress + alerts -->
  <div style="display:grid;grid-template-columns:1fr 340px;gap:20px;margin-bottom:24px">
    <div>
      <div class="card-title mb-2" style="font-size:15px;font-weight:600;color:var(--navy)">Department Progress</div>
      <div class="dept-progress-grid">
        {% for dept in departments %}
        {% set ds = dept_stats[dept] %}
        <div class="dept-progress-card">
          <div class="dept-progress-name">{{ dept }}</div>
          <div class="progress-bar-wrap">
            <div class="progress-bar-fill" style="width:{{ ds.pct }}%"></div>
          </div>
          <div class="dept-progress-nums">
            <span>{{ ds.pct }}%</span>
            <span>{{ ds.done }}/{{ ds.total }}</span>
          </div>
        </div>
        {% endfor %}
      </div>
    </div>

    <div>
      {% if blocked %}
      <div class="card mb-2">
        <div class="card-header" style="background:#fff5f5">
          <span class="card-title" style="color:var(--danger)">ğŸš« Blocked Tasks ({{ blocked|length }})</span>
        </div>
        <div>
          {% for t in blocked %}
          <div class="activity-item">
            <div class="activity-dot" style="background:var(--danger)"></div>
            <div class="activity-text">
              <a href="{{ url_for('task_detail', task_id=t.id) }}" style="color:var(--navy);text-decoration:none;font-weight:500">{{ t.name }}</a>
              <div style="font-size:11px;color:var(--gray-400)">{{ t.department }}</div>
            </div>
          </div>
          {% endfor %}
        </div>
      </div>
      {% endif %}

      {% if overdue %}
      <div class="card mb-2">
        <div class="card-header" style="background:#fffbeb">
          <span class="card-title" style="color:var(--warning)">âš ï¸ Overdue Tasks ({{ overdue|length }})</span>
        </div>
        <div>
          {% for t in overdue %}
          <div class="activity-item">
            <div class="activity-dot" style="background:var(--warning)"></div>
            <div class="activity-text">
              <a href="{{ url_for('task_detail', task_id=t.id) }}" style="color:var(--navy);text-decoration:none;font-weight:500">{{ t.name }}</a>
              <div style="font-size:11px;color:var(--gray-400)">{{ t.department }} Â· Due {{ t.due_date }}</div>
            </div>
          </div>
          {% endfor %}
        </div>
      </div>
      {% endif %}
    </div>
  </div>

  <!-- Recent activity -->
  <div class="card">
    <div class="card-header">
      <span class="card-title">ğŸ“° Recent Activity</span>
    </div>
    <div class="activity-feed">
      {% if activity %}
        {% for a in activity %}
        <div class="activity-item">
          <div class="activity-dot"></div>
          <div class="activity-text">
            <strong>{{ a.full_name or 'System' }}</strong>
            {% if a.action == 'Status Changed' %} changed
              {% if a.task_name %}<a href="{{ url_for('task_detail', task_id=a.task_id) }}" style="color:var(--navy)">{{ a.task_name }}</a>{% endif %}
              to <strong>{{ a.detail }}</strong>
            {% elif a.action == 'Note Added' %} added a note on
              {% if a.task_name %}<a href="{{ url_for('task_detail', task_id=a.task_id) }}" style="color:var(--navy)">{{ a.task_name }}</a>{% endif %}
            {% elif a.action == 'Task Created' %} created task <strong>{{ a.detail }}</strong>
            {% elif a.action == 'Clinic Created' %} created this clinic
            {% else %} {{ a.action }}: {{ a.detail }}
            {% endif %}
          </div>
          <div class="activity-time">{{ a.created_at[:16] }}</div>
        </div>
        {% endfor %}
      {% else %}
      <div class="empty-state" style="padding:24px">No activity yet.</div>
      {% endif %}
    </div>
  </div>
</div>

<style>
@media (max-width: 768px) {
  div[style*="grid-template-columns:1fr 340px"] { grid-template-columns: 1fr !important; }
}
</style>
{% endblock %}
